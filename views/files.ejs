<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= project.name %> - Files</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #0e0e10; --panel: #151519; --accent: #6366f1; --border: #2b2b36; }
        body { background-color: var(--bg); color: #e4e4f0; font-family: 'Inter', sans-serif; }
        #sidebar { width: 260px; background: #121216; position: fixed; top: 0; left: -260px; height: 100vh; z-index: 99; transition: 0.3s; border-right: 1px solid var(--border); }
        #sidebar.active { left: 0; }
        .overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 98; }
        #sidebar.active ~ .overlay { display: block; }
        .menu-item { padding: 12px 20px; color: #8f8f9e; display: block; text-decoration: none; transition: 0.2s; }
        .menu-item:hover, .menu-item.active { background: rgba(99,102,241,0.1); border-left: 3px solid var(--accent); color: white; }
        .content { padding: 25px; transition: 0.3s; }
        
        .file-card { background: var(--panel); border-radius: 8px; border: 1px solid var(--border); }
        .file-header { padding: 15px; background: rgba(255,255,255,0.02); border-bottom: 1px solid var(--border); }
        .file-row { padding: 10px 15px; border-bottom: 1px solid var(--border); display: flex; align-items: center; cursor: pointer; transition: 0.2s; }
        .file-row:hover { background: rgba(255,255,255,0.05); }
        .editor-container { width: 100%; height: 75vh; }
        .crumb-link { color: var(--accent); text-decoration: none; margin: 0 5px; font-weight: bold; }
    </style>
</head>
<body>
    <div id="sidebar">
        <div class="p-4 border-bottom border-secondary"><h5 class="m-0 fw-bold text-white">MANAGER</h5></div>
        <div class="mt-3">
            <a href="/dashboard" class="menu-item"><i class="fas fa-arrow-left me-2"></i>Dashboard</a>
            <div class="px-4 py-2 mt-2 text-muted small fw-bold">SERVER</div>
            <a href="/user/project/<%= project.uuid %>" class="menu-item"><i class="fas fa-terminal me-2"></i>Console</a>
            <a href="/user/project/<%= project.uuid %>/files" class="menu-item active"><i class="fas fa-folder me-2"></i>Files</a>
        </div>
    </div>
    <div class="overlay" onclick="toggleSb()"></div>

    <div class="content">
        <div class="d-flex align-items-center gap-3 mb-4">
            <button class="btn btn-dark border-secondary" onclick="toggleSb()"><i class="fas fa-bars"></i></button>
            <h4 class="m-0 fw-bold"><%= project.name %></h4>
        </div>

        <div class="file-card">
            <div class="file-header d-flex justify-content-between align-items-center">
                <div class="font-monospace text-muted">
                    <a href="/user/project/<%= project.uuid %>/files" class="text-muted text-decoration-none"><i class="fas fa-home"></i></a>
                    <% let cLink = ""; currentPath.split('/').forEach(part => { 
                       if(part) { cLink += "/" + part; %>
                       / <a href="/user/project/<%= project.uuid %>/files?path=<%= cLink.substring(1) %>" class="crumb-link"><%= part %></a>
                    <% }}); %>
                </div>
                <div class="d-flex gap-2">
                    <form action="/api/project/<%= project.uuid %>/delete" method="POST" id="bulkForm">
                        <button class="btn btn-danger btn-sm d-none" id="bulkBtn"><i class="fas fa-trash me-1"></i> Delete Selected</button>
                    </form>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#newFileModal">New File</button>
                    <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#uploadModal">Upload</button>
                </div>
            </div>

            <% if(currentPath) { 
               let backArr = currentPath.split('/'); backArr.pop(); let backLink = backArr.join('/'); 
            %>
            <div class="file-row" onclick="location.href='/user/project/<%= project.uuid %>/files?path=<%= backLink %>'">
                <div style="width: 30px"><i class="fas fa-level-up-alt text-muted"></i></div>
                <div class="fw-bold text-muted">...</div>
            </div>
            <% } %>

            <% if(files.length === 0) { %><div class="p-5 text-center text-muted">Empty Directory</div><% } %>

            <% files.forEach(f => { 
               const fullPath = currentPath ? currentPath + '/' + f.name : f.name;
            %>
            <div class="file-row">
                <div style="width: 30px" onclick="event.stopPropagation()">
                    <input type="checkbox" class="form-check-input bg-dark border-secondary file-chk" value="<%= fullPath %>" form="bulkForm" name="files[]" onchange="chk()">
                </div>
                <div style="width: 40px"><i class="fas <%= f.isDir ? 'fa-folder text-warning' : 'fa-file-code text-info' %>"></i></div>
                <div class="flex-grow-1 text-white" onclick="handle('<%= f.name %>', <%= f.isDir %>)"><%= f.name %></div>
                <div class="text-muted small gap-3 d-flex align-items-center me-2">
                    <span><%= f.size %></span>
                    <span class="d-none d-md-block"><%= f.date %></span>
                    <div class="dropdown" onclick="event.stopPropagation()">
                        <i class="fas fa-ellipsis-v px-2 text-white" data-bs-toggle="dropdown"></i>
                        <ul class="dropdown-menu dropdown-menu-dark border-secondary">
                            <li><a class="dropdown-item" href="#" onclick="handle('<%= f.name %>', <%= f.isDir %>)">Open/Edit</a></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="del('<%= fullPath %>')">Delete</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <% }) %>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal fade" id="uploadModal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary text-white">
                <div class="modal-header border-secondary"><h5>Upload</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <form action="/project/<%= project.uuid %>/upload?path=<%= currentPath %>" method="POST" enctype="multipart/form-data">
                    <div class="modal-body"><input type="file" name="file" class="form-control bg-black border-secondary text-white" required></div>
                    <div class="modal-footer border-secondary"><button class="btn btn-primary w-100">Start Upload</button></div>
                </form>
            </div>
        </div>
    </div>

    <!-- Editor Modal (Visual Code Editor) -->
    <div class="modal fade" id="editorModal" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary text-white">
                <div class="modal-header border-secondary py-2 px-3">
                    <span id="editPath" class="badge bg-secondary font-monospace"></span>
                    <div class="gap-2 d-flex"><button class="btn btn-success btn-sm" onclick="save()">Save</button><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                </div>
                <div class="modal-body p-0"><div id="editor" class="editor-container"></div></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ace.js"></script>
    <script>
        function toggleSb() { document.getElementById('sidebar').classList.toggle('active'); }
        
        // Setup Ace Editor
        const editor = ace.edit("editor"); 
        editor.setTheme("ace/theme/twilight"); 
        editor.session.setMode("ace/mode/javascript");
        editor.setOptions({ fontSize: "14px", showPrintMargin: false });

        const edModal = new bootstrap.Modal(document.getElementById('editorModal'));
        let openPath = ''; const root = '<%= currentPath %>';

        function handle(name, isDir) {
            const target = root ? root + '/' + name : name;
            if(isDir) window.location.href = `/user/project/<%= project.uuid %>/files?path=${target}`;
            else {
                openPath = target;
                document.getElementById('editPath').innerText = target;
                // Fetch file content via API
                fetch('/api/project/<%= project.uuid %>/read', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({path:target}) })
                .then(r=>r.text()).then(t => { editor.setValue(t, -1); edModal.show(); });
            }
        }

        function save() {
            // Save file content via API
            fetch('/api/project/<%= project.uuid %>/save', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({path:openPath, content:editor.getValue()}) })
            .then(() => { edModal.hide(); alert('File Saved Successfully!'); });
        }

        function del(path) {
            if(confirm('Are you sure you want to delete this file?')) {
                const f=document.createElement('form'); f.method='POST'; f.action='/api/project/<%= project.uuid %>/delete';
                const i=document.createElement('input'); i.name='path'; i.value=path; f.appendChild(i); document.body.appendChild(f); f.submit();
            }
        }

        function chk() {
            const boxes = document.querySelectorAll('.file-chk:checked');
            const btn = document.getElementById('bulkBtn');
            if(boxes.length > 0) btn.classList.remove('d-none'); else btn.classList.add('d-none');
        }
    </script>
</body>
</html>
