<%- include('partials/header') %>
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8" data-aos="fade-up">
            
            <div class="card border-0 shadow-lg rounded-4 overflow-hidden mb-4 position-relative">
                <div style="height: 150px; background: linear-gradient(135deg, #6c5ce7, #a29bfe);"></div>
                <div class="card-body p-4 text-center" style="margin-top: -80px;">
                    <div class="position-relative d-inline-block mb-3">
                        <img src="<%= user.profilePic %>" class="rounded-circle border border-4 border-white shadow" width="140" height="140" style="object-fit: cover; background: white;" id="previewImg">
                        <label for="fileInput" class="position-absolute bottom-0 end-0 bg-dark text-white rounded-circle p-2 shadow cursor-pointer hover-scale">
                            <i class="fas fa-camera"></i>
                        </label>
                    </div>
                    <h3 class="fw-bold mb-1"><%= user.fullname %></h3>
                    <p class="text-muted mb-3">@<%= user.username %> <span class="badge bg-<%= user.role=='admin'?'danger':'primary' %> rounded-pill ms-1"><%= user.role %></span></p>
                    
                    <div class="row g-3 justify-content-center mb-4">
                        <div class="col-4">
                            <div class="p-3 bg-light rounded-3">
                                <h5 class="fw-bold mb-0 text-primary"><%= user.sessions.length %></h5>
                                <small class="text-muted" style="font-size: 10px;">ACTIVE BOTS</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-3 bg-light rounded-3">
                                <h5 class="fw-bold mb-0 text-success"><%= projects.length %></h5>
                                <small class="text-muted" style="font-size: 10px;">SERVERS</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-3 bg-light rounded-3">
                                <h5 class="fw-bold mb-0 text-warning"><%= user.isPremium ? 'PRO' : 'FREE' %></h5>
                                <small class="text-muted" style="font-size: 10px;">PLAN</small>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-outline-dark rounded-pill px-4 fw-bold" data-bs-toggle="modal" data-bs-target="#ticketModal">
                        <i class="fas fa-life-ring me-2"></i>Open Support Ticket
                    </button>
                </div>
            </div>

            <div class="card border-0 shadow-sm rounded-4 p-4 mb-4" data-aos="fade-up" data-aos-delay="100">
                <h5 class="fw-bold mb-4"><i class="fas fa-user-edit text-primary me-2"></i>Edit Informasi</h5>
                <form action="/profile/update" method="POST" enctype="multipart/form-data">
                    <input type="file" name="profilePic" id="fileInput" class="d-none" accept="image/*" onchange="document.getElementById('previewImg').src = window.URL.createObjectURL(this.files[0])">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label small text-muted fw-bold">Fullname</label>
                            <input type="text" name="fullname" class="form-control bg-light border-0" value="<%= user.fullname %>" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small text-muted fw-bold">Username</label>
                            <input type="text" name="username" class="form-control bg-light border-0" value="<%= user.username %>" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label small text-muted fw-bold">Email Address</label>
                            <input type="email" class="form-control bg-light border-0" value="<%= user.email %>" readonly>
                        </div>
                    </div>
                    <div class="text-end mt-4">
                        <button type="submit" class="btn btn-primary rounded-pill px-5 fw-bold shadow-sm">Simpan Perubahan</button>
                    </div>
                </form>
            </div>

            <div class="card border-0 shadow-sm rounded-4 p-4 mb-4" data-aos="fade-up" data-aos-delay="200">
                <h5 class="fw-bold mb-4"><i class="fas fa-user-friends text-success me-2"></i>Sistem Referral</h5>
                <p class="text-muted small">Undang teman Anda menggunakan link di bawah ini. Setiap 5 teman yang berhasil mendaftar, Anda akan mendapatkan bonus +1 Slot Cloud Server secara otomatis.</p>
                <div class="bg-light p-3 rounded-3 text-center border mb-3">
                    <small class="text-muted d-block mb-1">LINK REFERRAL ANDA</small>
                    <div class="input-group">
                        <input type="text" class="form-control fw-bold text-center border-0 bg-white" value="<%= `https://wanzofc.site/register?ref=${user.referralCode}` %>" id="referralLink" readonly>
                        <button class="btn btn-outline-primary" onclick="copyReferral()">
                            <i class="fas fa-copy"></i> Salin
                        </button>
                    </div>
                </div>
                <div class="progress" style="height: 25px;">
                    <div class="progress-bar bg-success progress-bar-striped progress-bar-animated" role="progressbar" style="width: <%= (user.referrals.length % 5) * 20 %>%" aria-valuenow="<%= user.referrals.length % 5 %>" aria-valuemin="0" aria-valuemax="5">
                        <span class="fw-bold"><%= user.referrals.length % 5 %> / 5 Menuju Bonus</span>
                    </div>
                </div>
                <p class="text-center small mt-2 fw-bold text-muted">Total Teman Direferensikan: <span class="text-success"><%= user.referrals.length %></span></p>
            </div>

            <div class="card border-0 shadow-sm rounded-4 p-4" data-aos="fade-up" data-aos-delay="300">
                <h5 class="fw-bold mb-4"><i class="fas fa-history text-danger me-2"></i>Riwayat Login</h5>
                <div class="table-responsive">
                    <table class="table table-borderless table-hover small align-middle">
                        <thead>
                            <tr class="text-muted border-bottom">
                                <th>Waktu</th>
                                <th>Alamat IP</th>
                                <th>Perangkat</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if(user.loginHistory && user.loginHistory.length > 0) { %>
                                <% user.loginHistory.slice(0, 5).forEach(log => { %>
                                    <tr>
                                        <td><%= new Date(log.timestamp).toLocaleString() %></td>
                                        <td><span class="badge bg-light text-dark border"><%= log.ip %></span></td>
                                        <td class="text-truncate" style="max-width: 200px;"><%= log.userAgent %></td>
                                    </tr>
                                <% }) %>
                            <% } else { %>
                                <tr><td colspan="3" class="text-center py-3">Belum ada riwayat login.</td></tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="ticketModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0">
                <h5 class="fw-bold">Contact Support</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/ticket/create" method="POST">
                <div class="modal-body">
                    <input type="text" name="subject" class="form-control bg-light border-0 mb-3" placeholder="Subject / Masalah" required>
                    <textarea name="message" class="form-control bg-light border-0" rows="5" placeholder="Jelaskan masalah anda secara detail..." required></textarea>
                </div>
                <div class="modal-footer border-0">
                    <button type="submit" class="btn btn-dark rounded-pill px-4 w-100">Kirim Tiket</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function copyReferral() {
        var copyText = document.getElementById("referralLink");
        copyText.select();
        copyText.setSelectionRange(0, 99999); 
        navigator.clipboard.writeText(copyText.value);
        Swal.fire({
            icon: 'success',
            title: 'Berhasil Disalin!',
            text: 'Bagikan link ini ke teman Anda.',
            timer: 1500,
            showConfirmButton: false
        });
    }
</script>

<%- include('partials/footer') %>