<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= project.name %> - Console</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/xterm/3.14.5/xterm.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg-main: #0e0e10; --sidebar-w: 260px; --accent: #6366f1; }
        body { background-color: var(--bg-main); color: #e4e4f0; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        #sidebar { width: var(--sidebar-w); background: #121216; position: fixed; top: 0; left: -260px; height: 100vh; z-index: 999; transition: 0.3s; border-right: 1px solid #2b2b36; }
        #sidebar.active { left: 0; }
        .menu-item { padding: 12px 25px; color: #8f8f9e; display: block; text-decoration: none; transition: 0.2s; }
        .menu-item:hover, .menu-item.active { color: white; background: rgba(99, 102, 241, 0.1); border-left: 3px solid var(--accent); }
        .overlay { display: none; position: fixed; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index: 998; }
        #sidebar.active ~ .overlay { display: block; }
        .content { padding: 25px; transition: 0.3s; min-height: 100vh; margin-left: 0; }
        .header-card { background: #151519; padding: 20px; border-radius: 10px; border: 1px solid #2b2b36; margin-bottom: 20px; }
        #terminal { background: #000; height: 70vh; border-radius: 8px; padding: 10px; border: 1px solid #2b2b36; overflow: hidden; }
    </style>
</head>
<body>
    <div id="sidebar">
        <div class="p-4 border-bottom border-secondary"><h5 class="m-0 fw-bold text-white">SERVER MANAGER</h5></div>
        <div class="mt-3">
            <a href="/dashboard" class="menu-item"><i class="fas fa-arrow-left me-3"></i> List Servers</a>
            <div class="px-4 py-2 text-muted small fw-bold mt-2">CONTROLS</div>
            <a href="/user/project/<%= project.uuid %>" class="menu-item active"><i class="fas fa-terminal me-3"></i> Console</a>
            <a href="/user/project/<%= project.uuid %>/files" class="menu-item"><i class="fas fa-folder me-3"></i> File Manager</a>
        </div>
    </div>
    <div class="overlay" onclick="toggleSidebar()"></div>

    <div class="content">
        <div class="d-flex justify-content-between mb-4 align-items-center">
            <div class="d-flex align-items-center gap-3">
                <button class="btn btn-dark border-secondary" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
                <div><h4 class="m-0 fw-bold"><%= project.name %></h4><small class="text-muted"><%= project.uuid.split('-')[0] %></small></div>
            </div>
            <span class="badge bg-success px-3 py-2">RUNNING</span>
        </div>

        <div class="header-card d-flex justify-content-between align-items-center">
            <div>
                <small class="text-muted d-block">Server Status: <span class="text-success fw-bold">Active</span></small>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-success btn-sm fw-bold px-3" onclick="sendCmd('npm start\r')">START</button>
                <button class="btn btn-warning btn-sm fw-bold px-3" onclick="restartProcess()">RESTART</button>
                <button class="btn btn-danger btn-sm fw-bold px-3" onclick="sendCmd('\x03')">STOP</button>
            </div>
        </div>

        <div id="terminal"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xterm/3.14.5/xterm.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xterm/3.14.5/addons/fit/fit.min.js"></script>
    <script>
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }
        
        Terminal.applyAddon(fit);
        const term = new Terminal({ 
            cursorBlink: true, 
            fontSize: 14, 
            fontFamily: 'Menlo, Monaco, "Courier New", monospace',
            background: '#000', 
            theme: { background: '#000' },
            convertEol: true
        });
        
        term.open(document.getElementById('terminal')); 
        term.fit();
        window.addEventListener('resize', () => term.fit());

        const socket = io();
        const pid = '<%= project.uuid %>';
        let commandBuffer = ""; 

        socket.emit('join-project', pid);
        socket.emit('term-connect', { uuid: pid });
        
        socket.on('term-output', d => term.write(d));

        term.on('data', d => {
            if (d === '\r') { 
                const cleanCmd = commandBuffer.trim().toLowerCase();
                const forbidden = ['passwd', 'sudo', 'su', 'rm -rf /', 'mkfs', 'shutdown', 'reboot', 'init 0', 'poweroff'];
                
                if (forbidden.some(cmd => cleanCmd === cmd || cleanCmd.startsWith(cmd + ' '))) {
                    term.write('\r\n\x1b[1;31mSecurity Alert: Command forbidden.\x1b[0m\r\n$ ');
                    commandBuffer = ""; 
                    return; 
                }
                
                socket.emit('term-input', { uuid: pid, input: d });
                commandBuffer = ""; 
            } else if (d === '\u007F') { 
                if (commandBuffer.length > 0) {
                    commandBuffer = commandBuffer.slice(0, -1);
                    socket.emit('term-input', { uuid: pid, input: d });
                }
            } else {
                commandBuffer += d;
                socket.emit('term-input', { uuid: pid, input: d });
            }
        });

        function sendCmd(c) { 
            socket.emit('term-input', { uuid: pid, input: c }); 
        }
        
        function restartProcess() {
            sendCmd('\x03'); 
            setTimeout(() => {
                sendCmd('npm start\r');
            }, 1000);
        }
    </script>
</body>
</html>