<!DOCTYPE html>
<html lang="id">
<%- include('partials/header') %>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-danger shadow-sm sticky-top">
        <div class="container"><a class="navbar-brand fw-bold" href="#"><i class="fas fa-user-shield me-2"></i>ADMIN PANEL</a><a href="/logout" class="btn btn-light btn-sm text-danger rounded-pill fw-bold">Logout</a></div>
    </nav>
    <div class="container py-5">
        <!-- Stats Rows -->
        <div class="row g-4 mb-5">
            <div class="col-md-3"><div class="card border-0 shadow-sm p-3 rounded-4"><h4><%= stats.totalUsers %></h4><span class="text-muted">Total Users</span></div></div>
            <div class="col-md-3"><div class="card border-0 shadow-sm p-3 rounded-4"><h4><%= stats.totalSessions %></h4><span class="text-muted">Total Bots</span></div></div>
            <div class="col-md-3"><div class="card border-0 shadow-sm p-3 rounded-4"><h4><%= stats.activeSessions %></h4><span class="text-muted">Online</span></div></div>
            <div class="col-md-3"><div class="card border-0 shadow-sm p-3 rounded-4"><h4><%= tickets.length %></h4><span class="text-muted">Support Tickets</span></div></div>
        </div>

        <div class="row mb-5">
            <!-- Left Column: Flash Sale & System -->
            <div class="col-lg-6 mb-4">
                
                <!-- Flash Sale Configuration -->
                <div class="card border-0 shadow-sm rounded-4 p-4 mb-4">
                    <h5 class="fw-bold mb-3 text-danger"><i class="fas fa-bolt me-2"></i>Flash Sale Config</h5>
                    <form action="/admin/flashsale" method="POST">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" name="active" <%= settings.flashSale.active ? 'checked' : '' %>>
                            <label class="form-check-label fw-bold">Aktifkan Flash Sale</label>
                        </div>
                        <label class="small text-muted">Waktu Berakhir</label>
                        <input type="datetime-local" name="endTime" class="form-control mb-2" required>
                        
                        <input type="text" name="title" class="form-control mb-2" placeholder="Judul Promo" value="<%= settings.flashSale.title %>">
                        <input type="text" name="description" class="form-control mb-2" placeholder="Deskripsi Singkat" value="<%= settings.flashSale.description %>">
                        
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="small text-muted">Harga (Rp)</label>
                                <input type="number" name="price" class="form-control" placeholder="0" value="<%= settings.flashSale.price %>">
                            </div>
                            <div class="col-6">
                                <label class="small text-muted">Reward Slot</label>
                                <input type="number" name="rewardSlots" class="form-control" placeholder="1" value="<%= settings.flashSale.rewardSlots %>">
                            </div>
                        </div>
                        
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" name="isFree" <%= settings.flashSale.isFree ? 'checked' : '' %>>
                            <label class="form-check-label text-success fw-bold">Gratis (Claim System)</label>
                        </div>
                        
                        <button class="btn btn-danger w-100 rounded-pill mt-3 fw-bold">Simpan Pengaturan Flash Sale</button>
                    </form>
                </div>

                <!-- System Control -->
                <div class="card border-0 shadow-sm rounded-4 p-4">
                    <h5 class="fw-bold mb-3">System Control</h5>
                    <form action="/admin/maintenance" method="POST" class="mb-4">
                        <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
                            <div><h6 class="fw-bold mb-0">Maintenance Mode</h6><small class="text-muted">Block access for users.</small></div>
                            <div class="form-check form-switch"><input class="form-check-input" type="checkbox" name="maintenance" onchange="this.form.submit()" <%= settings.maintenance ? 'checked' : '' %> style="transform: scale(1.5);"></div>
                        </div>
                    </form>
                    
                    <h6 class="fw-bold">Add Onboarding Alert</h6>
                    <form action="/admin/onboarding/add" method="POST" enctype="multipart/form-data">
                        <input type="text" name="title" class="form-control mb-2" placeholder="Title" required>
                        <textarea name="message" class="form-control mb-2" placeholder="Message" required></textarea>
                        <input type="file" name="image" class="form-control mb-3" accept="image/*">
                        <button class="btn btn-primary w-100 rounded-pill">Publish Alert</button>
                    </form>
                    
                    <div class="mt-3">
                        <label class="small fw-bold text-muted">Active Alerts:</label>
                        <% settings.onboarding.forEach(o => { %>
                            <div class="d-flex justify-content-between border-bottom py-2 align-items-center">
                                <span class="small text-truncate" style="max-width: 200px;"><%= o.title %></span>
                                <form action="/admin/onboarding/delete" method="POST" class="m-0"><input type="hidden" name="id" value="<%= o._id %>"><button class="btn btn-sm btn-outline-danger rounded-circle"><i class="fas fa-trash"></i></button></form>
                            </div>
                        <% }) %>
                    </div>
                </div>
            </div>

            <!-- Right Column: Tutorials & Content -->
            <div class="col-lg-6 mb-4">
                <div class="card border-0 shadow-sm rounded-4 p-4 h-100">
                    <h5 class="fw-bold mb-3">Add Detailed Tutorial</h5>
                    <form action="/admin/tutorial/add" method="POST">
                        <input type="text" name="title" class="form-control mb-2" placeholder="Judul Tutorial" required>
                        <textarea name="description" class="form-control mb-2" placeholder="Deskripsi Singkat" required></textarea>
                        <div class="row g-2 mb-2">
                            <div class="col-6">
                                <input type="text" name="category" class="form-control" placeholder="Kategori (e.g. Bot, Server)" required>
                            </div>
                            <div class="col-6">
                                <input type="text" name="thumbnail" class="form-control" placeholder="Link Thumbnail URL">
                            </div>
                        </div>
                        <input type="text" name="youtubeUrl" class="form-control mb-2" placeholder="Link YouTube (Optional)">
                        <label class="small text-muted fw-bold">Langkah-langkah (Pisahkan dengan Enter):</label>
                        <textarea name="steps" class="form-control mb-3" rows="6" placeholder="1. Buka dashboard&#10;2. Klik menu..." required style="white-space: pre-wrap;"></textarea>
                        <button class="btn btn-success w-100 rounded-pill fw-bold">Publish Tutorial</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Ticket Support Management -->
        <div class="card border-0 shadow-lg rounded-4 overflow-hidden mb-5">
            <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                <h5 class="fw-bold m-0 text-primary"><i class="fas fa-ticket-alt me-2"></i>Support Tickets</h5>
                <span class="badge bg-primary rounded-pill"><%= tickets.length %> Open</span>
            </div>
            <div class="table-responsive">
                <table class="table mb-0 align-middle">
                    <thead class="bg-light"><tr><th class="ps-4">User</th><th>Subject</th><th>Status</th><th>Date</th><th>Action</th></tr></thead>
                    <tbody>
                        <% if(tickets.length === 0) { %>
                            <tr><td colspan="5" class="text-center py-4 text-muted">No open tickets.</td></tr>
                        <% } %>
                        <% tickets.forEach(t => { %>
                        <tr>
                            <td class="ps-4 fw-bold"><%= t.userId ? t.userId.username : 'Unknown' %></td>
                            <td><%= t.subject %></td>
                            <td><span class="badge bg-<%= t.status=='open'?'warning':'success' %>"><%= t.status %></span></td>
                            <td><%= t.createdAt.toLocaleDateString() %></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#ticketModal<%= t._id %>">Reply</button>
                            </td>
                        </tr>
                        
                        <!-- Reply Modal -->
                        <div class="modal fade" id="ticketModal<%= t._id %>" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content border-0 shadow">
                                    <div class="modal-header">
                                        <h5 class="fw-bold">Reply Ticket</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <form action="/admin/ticket/reply" method="POST">
                                        <input type="hidden" name="id" value="<%= t._id %>">
                                        <div class="modal-body">
                                            <div class="bg-light p-3 rounded mb-3 border">
                                                <small class="text-muted d-block mb-1">User Message:</small>
                                                <p class="mb-0 fw-bold"><%= t.message %></p>
                                            </div>
                                            <label class="small text-muted">Admin Reply:</label>
                                            <textarea name="reply" class="form-control" rows="4" placeholder="Tulis balasan anda..." required></textarea>
                                        </div>
                                        <div class="modal-footer border-0">
                                            <button class="btn btn-primary w-100 rounded-pill fw-bold">Send Reply & Close Ticket</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- User List Table -->
        <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
            <div class="card-header bg-white border-0 py-3"><h5 class="fw-bold m-0">User Management</h5></div>
            <div class="table-responsive">
                <table class="table mb-0">
                    <thead class="bg-light"><tr><th class="ps-4">Username</th><th>Email</th><th>Role</th><th>Status</th><th>Bots</th></tr></thead>
                    <tbody><% allUsers.forEach(u => { %>
                        <tr>
                            <td class="ps-4 fw-bold"><%= u.username %></td>
                            <td><%= u.email %></td>
                            <td><span class="badge bg-<%= u.role=='admin'?'danger':'secondary' %>"><%= u.role %></span></td>
                            <td><%= u.isPremium?'Premium':'Free' %></td>
                            <td><%= u.sessions.length %></td>
                        </tr>
                    <% }) %></tbody>
                </table>
            </div>
        </div>
    </div>
<%- include('partials/footer') %>
</body>
</html>
